#!/bin/bash -x

(
    flock -n 9
    FILE="${1:-/var/lib/bbctrl/firmware/update.tar.bz2}"

    if [ ! -e "$FILE" ]; then
      echo "Missing $FILE"
      exit 1
    fi

    systemctl stop bbctrl

    rm -rf /tmp/update
    mkdir /tmp/update
    
    # Get absolute path of input file
    ABSOLUTE_FILE=$(readlink -f "$FILE")
    
    cd /tmp/update

    LOG=/var/log/bbctrl.$(date +%Y%m%d-%H%M%S).install
    tar xf "$ABSOLUTE_FILE"
    
    # Find the extracted directory (should be bbctrl-*)
    EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "bbctrl-*")
    if [ -z "$EXTRACTED_DIR" ]; then
        echo "Error: Could not find extracted bbctrl directory"
        exit 1
    fi
    
    cd "$EXTRACTED_DIR"
    if [ ! -f "scripts/install.sh" ]; then
        echo "Error: Could not find scripts/install.sh"
        exit 1
    fi
    
    # Create camotics/__init__.py if needed
    mkdir -p src/py/camotics
    touch src/py/camotics/__init__.py
    
    # Create empty dphys-swapfile if it doesn't exist
    if [ ! -f "/etc/dphys-swapfile" ]; then
        touch /etc/dphys-swapfile
    fi
    
    # Run install without AVR update since we don't have the serial port
    ./scripts/install.sh --no-avr 2>&1 > "$LOG"

    cd -
    rm -rf /tmp/update "$FILE"

) 9> /var/lock/bbctrl.update.lock